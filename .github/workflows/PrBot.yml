name: Bot scan
on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited]
  issues:
    types: [opened, edited, milestoned] 
permissions:
  issues: write
  pull-requests: write

jobs:
  Snyk_scanning:
    name: Snyk Bot scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Snyk Bot scan
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm install
          echo "Downloading and authenticating Snyk CLI..."
          curl -Lo ./snyk "https://github.com/snyk/snyk/releases/download/v1.1100.0/snyk-linux"
          chmod +x snyk
          ./snyk auth ${{ secrets.SNYK_TOKEN }}
          echo "Running Snyk test and monitor..."
          ./snyk test --all-projects --color --json || true
          ./snyk monitor --all-projects || true

  TruffleHog_scanning:
    name: TruffleHog Bot scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # fetch all history so multiple commits can be scanned
      - name: TruffleHog Bot scan
        uses: trufflesecurity/TruffleHog-Enterprise-Github-Action@main
        with:
            args: --fail-verified ${{ github.event.pull_request.base.ref }} HEAD --json
  BotCheck:
    name: Bot scan 
    permissions: write-all
    runs-on: ubuntu-latest
    needs: [Snyk_scanning, TruffleHog_scanning]
    steps:
      - uses: itsarraj/pr-scan-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  secret_scan:
    name: Running Comprehensive Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install TruffleHog using pip
        run: |
          pip install truffleHog

      - name: Run TruffleHog Scan (pip)
        run: |
          trufflehog --regex --entropy=False ${GITHUB_HEAD_REF} --json > trufflehog_pip_scan.json

      - name: Run TruffleHog Enterprise Scan
        uses: trufflesecurity/TruffleHog-Enterprise-Github-Action@main
        with:
          args: --fail-verified ${{ github.event.repository.default_branch }} HEAD --json > trufflehog_action_scan.json

      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks-linux-amd64.tar.gz | tar -xz -C /usr/local/bin
          chmod +x /usr/local/bin/gitleaks

      - name: Run Gitleaks Scan
        run: |
          gitleaks detect --source . --report-format json --report-path gitleaks_scan.json

      - name: Combine Scan Results
        run: |
          echo "Combining scan results into a single file."
          echo "[" > combined_scan_results.json
          cat trufflehog_pip_scan.json >> combined_scan_results.json
          echo "," >> combined_scan_results.json
          cat trufflehog_action_scan.json >> combined_scan_results.json
          echo "," >> combined_scan_results.json
          cat gitleaks_scan.json >> combined_scan_results.json
          echo "]" >> combined_scan_results.json
          echo "Scan results combined into combined_scan_results.json"

      - name: Upload Scan Results
        uses: actions/upload-artifact@v2
        with:
          name: combined-scan-results
          path: combined_scan_results.json

